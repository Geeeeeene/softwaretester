# 集成测试模块使用说明

## 功能概述

集成测试模块支持使用 AI 生成 Catch2 格式的集成测试用例，并自动执行测试返回结果。

## 功能特性

1. **AI 生成测试用例**：根据 IntegrationTestIR 格式的测试需求，自动生成 Catch2 格式的 C++ 测试代码
2. **Catch2 执行**：使用现有的 Catch2 执行器编译并运行生成的测试用例
3. **结果返回**：返回详细的测试执行结果，包括通过/失败统计、日志等

## API 端点

### 1. 生成集成测试用例

**端点**: `POST /api/v1/integration-tests/{project_id}/generate`

**请求体**:
```json
{
  "test_ir": {
    "type": "integration",
    "name": "用户登录流程测试",
    "description": "测试用户登录的完整流程",
    "flow": [
      {
        "name": "登录接口",
        "url": "http://localhost:8000/api/v1/auth/login",
        "method": "POST",
        "headers": {
          "Content-Type": "application/json"
        },
        "body": {
          "username": "testuser",
          "password": "testpass"
        }
      }
    ],
    "validations": [
      {
        "type": "equals",
        "expected": 200,
        "actual": "response.status_code",
        "message": "登录应该返回200状态码"
      },
      {
        "type": "contains",
        "expected": "token",
        "actual": "response.body",
        "message": "响应应该包含token字段"
      }
    ],
    "required_services": ["auth-service"],
    "tags": ["login", "auth"],
    "priority": "high"
  },
  "additional_info": "可选：额外的测试要求说明"
}
```

**响应**:
```json
{
  "project_id": 1,
  "test_code": "#include \"catch_amalgamated.hpp\"\n...",
  "test_name": "用户登录流程测试"
}
```

### 2. 执行集成测试

**端点**: `POST /api/v1/integration-tests/{project_id}/execute`

**请求体**:
```json
{
  "test_code": "#include \"catch_amalgamated.hpp\"\n...",
  "source_file_path": "optional/path/to/source.cpp"
}
```

**响应**:
```json
{
  "success": true,
  "logs": "编译日志和执行日志...",
  "summary": {
    "total": 5,
    "passed": 4,
    "failed": 1,
    "assertions": {
      "successes": 8,
      "failures": 1
    },
    "cases": [...]
  },
  "project_id": 1
}
```

## 使用流程

### 步骤 1: 准备项目

确保项目已经创建并上传了源代码：

```bash
# 创建集成测试项目
POST /api/v1/projects
{
  "name": "我的集成测试项目",
  "project_type": "integration",
  "language": "cpp"
}

# 上传源代码（如果需要）
POST /api/v1/upload/project/{project_id}/source
```

### 步骤 2: 定义集成测试需求

根据 IntegrationTestIR 格式定义测试需求：

```python
test_ir = {
    "type": "integration",
    "name": "API 集成测试",
    "description": "测试 REST API 的完整流程",
    "flow": [
        {
            "name": "获取用户信息",
            "url": "http://localhost:8000/api/v1/users/1",
            "method": "GET",
            "headers": {"Authorization": "Bearer token123"}
        },
        {
            "name": "更新用户信息",
            "url": "http://localhost:8000/api/v1/users/1",
            "method": "PUT",
            "headers": {"Content-Type": "application/json"},
            "body": {"name": "新名称"}
        }
    ],
    "validations": [
        {
            "type": "equals",
            "expected": 200,
            "actual": "response.status_code"
        }
    ]
}
```

### 步骤 3: 生成测试用例

调用生成接口，AI 会根据测试需求生成 Catch2 格式的测试代码：

```python
response = requests.post(
    f"http://localhost:8000/api/v1/integration-tests/{project_id}/generate",
    json={
        "test_ir": test_ir,
        "additional_info": "使用 httpx 库发送 HTTP 请求"
    }
)
test_code = response.json()["test_code"]
```

### 步骤 4: 执行测试

使用生成的测试代码执行测试：

```python
response = requests.post(
    f"http://localhost:8000/api/v1/integration-tests/{project_id}/execute",
    json={
        "test_code": test_code
    }
)
result = response.json()
print(f"测试结果: {result['summary']}")
```

## IntegrationTestIR 格式说明

### ServiceEndpoint（服务端点）

```typescript
{
  name: string          // 端点名称
  url: string           // 请求URL
  method: "GET" | "POST" | "PUT" | "DELETE" | "PATCH"  // HTTP方法
  headers?: Record<string, string>  // 请求头
  body?: any            // 请求体（JSON对象）
}
```

### TestAssertion（测试断言）

```typescript
{
  type: "equals" | "not_equals" | "contains" | "throws" | "custom"
  expected: any         // 期望值
  actual?: string       // 实际值表达式（如 "response.status_code"）
  message?: string      // 断言失败时的错误消息
}
```

## 生成的测试代码特点

1. **使用 Catch2 框架**：生成的代码使用 Catch2 v3 混合版（`catch_amalgamated.hpp`）
2. **HTTP 请求支持**：AI 会根据需要选择合适的 HTTP 客户端库
3. **结构化测试**：使用 `TEST_CASE` 和 `SECTION` 组织测试步骤
4. **完整验证**：对每个验证点生成相应的断言

## 注意事项

1. **HTTP 客户端库**：生成的测试代码可能需要 HTTP 客户端库（如 httpx、curl 等），确保项目包含相应的依赖
2. **服务可用性**：执行测试前确保被测试的服务正在运行
3. **网络连接**：集成测试需要网络连接来访问服务端点
4. **编译环境**：需要 C++ 编译器和 Catch2 库（已包含在项目中）

## 示例：完整的集成测试流程

```python
import requests

BASE_URL = "http://localhost:8000/api/v1"
PROJECT_ID = 1

# 1. 定义测试需求
test_ir = {
    "type": "integration",
    "name": "用户认证流程测试",
    "flow": [
        {
            "name": "用户登录",
            "url": "http://localhost:8000/api/v1/auth/login",
            "method": "POST",
            "body": {"username": "test", "password": "test123"}
        },
        {
            "name": "获取用户信息",
            "url": "http://localhost:8000/api/v1/users/me",
            "method": "GET"
        }
    ],
    "validations": [
        {"type": "equals", "expected": 200, "actual": "login_response.status_code"},
        {"type": "contains", "expected": "token", "actual": "login_response.body"}
    ]
}

# 2. 生成测试用例
generate_response = requests.post(
    f"{BASE_URL}/integration-tests/{PROJECT_ID}/generate",
    json={"test_ir": test_ir}
)
test_code = generate_response.json()["test_code"]

# 3. 执行测试
execute_response = requests.post(
    f"{BASE_URL}/integration-tests/{PROJECT_ID}/execute",
    json={"test_code": test_code}
)
result = execute_response.json()

# 4. 查看结果
print(f"测试通过: {result['summary']['passed']}/{result['summary']['total']}")
print(f"日志:\n{result['logs']}")
```

## 与单元测试的区别

| 特性 | 单元测试 | 集成测试 |
|------|---------|---------|
| 测试对象 | 单个函数/类 | 多个组件/服务 |
| 测试方式 | 直接调用函数 | HTTP 请求 |
| 依赖 | Mock/Stub | 真实服务 |
| 执行环境 | 本地编译运行 | 需要网络连接 |
| 测试范围 | 函数级别 | 系统级别 |

## 故障排查

### 问题 1: 生成失败

- 检查 Claude API 配置是否正确
- 检查测试 IR 格式是否正确
- 查看后端日志了解详细错误

### 问题 2: 编译失败

- 检查项目源代码路径是否正确
- 检查是否包含必要的头文件和依赖
- 查看编译日志了解具体错误

### 问题 3: 执行失败

- 确保被测试的服务正在运行
- 检查网络连接
- 验证服务端点 URL 是否正确

## 后续改进

1. 支持更多 HTTP 客户端库选择
2. 支持 WebSocket 测试
3. 支持测试数据驱动
4. 支持测试结果持久化
5. 支持测试报告生成

