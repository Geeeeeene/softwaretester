# 集成测试功能 - 完整使用指南

## 功能概述

集成测试模块提供了完整的前后端集成，支持：
1. **前端界面**：可视化配置集成测试需求
2. **AI 生成**：自动生成 Catch2 格式的测试代码
3. **Catch2 执行**：编译并运行测试用例
4. **文件上传**：支持上传项目源代码
5. **结果展示**：详细的测试结果和日志

## 使用流程

### 1. 创建集成测试项目

在项目管理页面创建新项目，选择项目类型为"集成测试"。

### 2. 访问集成测试页面

在项目详情页面，点击"集成测试 (Catch2)"按钮，进入集成测试页面。

### 3. 上传源代码（可选）

如果需要编译包含项目代码的测试，可以点击"上传源代码"按钮上传 ZIP 文件。

### 4. 配置测试需求

在左侧面板配置测试需求：

#### 基本信息
- **测试名称**：输入测试用例的名称
- **描述**：输入测试用例的描述信息

#### 服务端点（Flow）
点击"添加"按钮添加服务端点，每个端点包含：
- **端点名称**：端点的描述性名称
- **URL**：要测试的服务端点 URL（如：`http://localhost:8000/api/v1/users/1`）
- **HTTP 方法**：GET、POST、PUT、DELETE 或 PATCH
- **请求体**：JSON 格式的请求体（仅 POST/PUT/PATCH 需要）

示例：
```
端点名称: 获取用户信息
URL: http://localhost:8000/api/v1/users/1
方法: GET
```

#### 验证规则（Validations）
点击"添加"按钮添加验证规则，每个验证包含：
- **验证类型**：equals（等于）、not_equals（不等于）、contains（包含）、throws（抛出异常）、custom（自定义）
- **期望值**：期望的结果值
- **实际值表达式**：用于获取实际值的表达式（如：`response.status_code`、`response.body.token`）

示例：
```
验证类型: equals
期望值: 200
实际值表达式: response.status_code
```

#### 额外信息（可选）
可以输入额外的测试要求说明，帮助 AI 生成更准确的测试代码。

### 5. 生成测试用例

配置完成后，点击"AI 生成测试用例"按钮。系统会：
1. 将测试需求发送给 AI（Claude）
2. AI 根据需求生成 Catch2 格式的 C++ 测试代码
3. 生成的代码显示在右侧代码编辑区域

### 6. 查看生成的代码

生成的代码会显示在右侧，包括：
- HTTP 请求发送代码
- 响应验证代码
- Catch2 测试框架代码

### 7. 执行测试

点击"执行测试"按钮，系统会：
1. 使用 Catch2 执行器编译测试代码
2. 运行测试用例
3. 返回测试结果

### 8. 查看结果

测试执行完成后，会显示：
- **测试结果摘要**：总用例数、通过数、失败数、断言统计
- **执行日志**：详细的编译和执行日志

## API 端点

### 生成测试用例
```
POST /api/v1/integration-tests/{project_id}/generate
```

请求体：
```json
{
  "test_ir": {
    "type": "integration",
    "name": "用户登录测试",
    "description": "测试用户登录流程",
    "flow": [
      {
        "name": "登录接口",
        "url": "http://localhost:8000/api/v1/auth/login",
        "method": "POST",
        "headers": {
          "Content-Type": "application/json"
        },
        "body": {
          "username": "test",
          "password": "test123"
        }
      }
    ],
    "validations": [
      {
        "type": "equals",
        "expected": 200,
        "actual": "response.status_code",
        "message": "状态码应为200"
      }
    ],
    "required_services": [],
    "tags": [],
    "priority": "medium"
  },
  "additional_info": "使用 httpx 库发送请求"
}
```

响应：
```json
{
  "project_id": 1,
  "test_code": "#include \"catch_amalgamated.hpp\"\n...",
  "test_name": "用户登录测试"
}
```

### 执行测试
```
POST /api/v1/integration-tests/{project_id}/execute
```

请求体：
```json
{
  "test_code": "#include \"catch_amalgamated.hpp\"\n...",
  "source_file_path": "optional/path/to/source.cpp"
}
```

响应：
```json
{
  "success": true,
  "logs": "编译和执行日志...",
  "summary": {
    "total": 5,
    "passed": 4,
    "failed": 1,
    "assertions": {
      "successes": 8,
      "failures": 1
    },
    "cases": [...]
  },
  "project_id": 1
}
```

## 前端页面结构

### 左侧面板：测试需求配置
- 基本信息输入
- 服务端点列表（可添加/删除）
- 验证规则列表（可添加/删除）
- 额外信息输入

### 右侧面板：代码和结果
- 操作按钮（生成/执行）
- 生成的测试代码显示
- 测试结果摘要
- 执行日志

## 技术实现

### 前端
- **页面组件**：`frontend/src/pages/IntegrationTestPage.tsx`
- **API 调用**：`frontend/src/lib/api.ts` 中的 `integrationTestsApi`
- **路由配置**：`frontend/src/App.tsx`

### 后端
- **API 端点**：`backend/app/api/v1/endpoints/integration_tests.py`
- **AI 生成服务**：`backend/app/services/test_generation.py` 中的 `generate_integration_test()`
- **Catch2 执行器**：`backend/app/executors/catch2_executor.py`

## 注意事项

1. **服务可用性**：执行测试前确保被测试的服务正在运行
2. **网络连接**：集成测试需要网络连接来访问服务端点
3. **HTTP 客户端库**：生成的测试代码可能需要 HTTP 客户端库，确保项目包含相应依赖
4. **源代码上传**：如果测试需要编译项目代码，请先上传源代码 ZIP 文件
5. **AI API 配置**：确保后端配置了 Claude API Key（`CLAUDE_API_KEY`）

## 故障排查

### 问题 1: 生成失败
- 检查 Claude API 配置
- 检查测试 IR 格式是否正确
- 查看后端日志

### 问题 2: 编译失败
- 检查是否上传了源代码
- 检查生成的代码是否包含必要的头文件
- 查看编译日志了解具体错误

### 问题 3: 执行失败
- 确保被测试的服务正在运行
- 检查网络连接
- 验证服务端点 URL 是否正确

### 问题 4: 前端无法连接后端
- 检查后端服务是否运行
- 检查 API 地址配置（`VITE_API_BASE_URL`）
- 查看浏览器控制台错误信息

## 示例场景

### 场景 1: REST API 测试
测试一个用户管理 API：
1. 添加端点：GET `/api/v1/users/1` - 获取用户信息
2. 添加验证：状态码等于 200，响应体包含 `id` 字段
3. 生成并执行测试

### 场景 2: 多步骤流程测试
测试用户注册流程：
1. 端点1：POST `/api/v1/auth/register` - 注册用户
2. 端点2：POST `/api/v1/auth/login` - 登录
3. 端点3：GET `/api/v1/users/me` - 获取当前用户信息
4. 添加多个验证规则
5. 生成并执行测试

## 后续改进计划

1. 支持保存测试配置
2. 支持测试用例模板
3. 支持批量执行
4. 支持测试报告导出
5. 支持 WebSocket 测试
6. 支持 GraphQL API 测试

